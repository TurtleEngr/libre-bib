#!/usr/bin/env bash

export cgDirApp=${cgDirApp:-/opt/libre-bib}
export cgBin=$cgDirApp/bin

#--------------------
fUsage() {
    cat <<EOF

Usage:
    bib [-n] Cmd
Cmds:
    import-lo, export-lo, backup-lo, restore-lo
    import-lib, update-lo
    ref-new, ref-update
    status, setup-bib, clean, connect, version, help
EOF
    exit 1
} # fUsage

# ========================================
if [[ $# -eq 0 || "$1" == "-h" ]]; then
    fUsage
fi
pParm=$*

if [[ ! -d $cgDirApp ]]; then
    echo "Error: cgDirApp $cgDirApp is not correct"
    exit 1
fi
if [[ ! -d $cgBin ]]; then
    echo "Error: cgBin $cgBin is not correct"
    exit 1
fi

if [[ "${cgBuild:-false}" != "true" && "$pParm" != "setup-bib" ]]; then
    if ! $cgBin/sanity-check.sh; then
        exit $?
    fi
fi

# Default conf
. $cgDirApp/etc/conf.env

if [[ "${cgBuild:-false}" != "true" ]]; then
    if [ ! -f conf.env ]; then
	echo 'Error: Missing conf.env, copying it now'
        make -f $cgBin/Makefile conf.env
        echo 'Edit conf.env with your details. Uncomment the ones you'
        echo 'are changing, then run: bib setup-bib'
        fUsage
    fi

    # User conf
    . ./conf.env
fi

tRun=""
if [[ "$cgNoExecCmd" == "true" ]]; then
    tRun="-n"
    tSilent=""
fi

tSilent="-s"
if [[ "$cgVerbose" == "true" ]]; then
    tSilent=""
fi

# Commands are executed with make
make -f $cgBin/Makefile $tRun $tSilent $pParm

if [[ "${cgBuild:-false}" != "true" ]]; then
    if [[ $? -ne 0 ]]; then
        fUsage
    fi
fi
